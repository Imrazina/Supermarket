<button id="enableCopyHelper">Zapnout automatické kopírování</button>
<script>
    // Konfigurace
    const PUBLIC_KEY = 'BBoYaoc8zDDFcRjeUDuO4HI15lrxOhtqEgdWfcfkn5vqTHmUeZc_DU6yodFwDNcthvOyKSK-K_Us9xdEDVYR_5I';
    const SERVICE_WORKER_PATH = '/sw.js';
    const originCandidate = (window.location.origin && window.location.origin !== 'null') ? window.location.origin : '';
    const guessedLocalApi = (!originCandidate || (window.location.hostname === 'localhost' && window.location.port !== '8082'))
        ? 'http://localhost:8082'
        : originCandidate;
    const apiBaseUrl = (document.body.dataset.apiBase?.trim() || window.API_BASE_URL || guessedLocalApi).replace(/\/$/, '');
    const API_ENDPOINT = `${apiBaseUrl}/api/push/subscribe`;

    async function initPushNotifications() {
        try {
            // 1. Kontrola podpory
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                throw new Error('Push notifications not supported');
            }

            // 2. Kontrola přihlášení
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            if (!token || !username) {
                throw new Error('Not authenticated');
            }

            // 3. Registrace Service Workeru
            console.log('[Push] Registruji Service Worker…');
            const registration = await navigator.serviceWorker.register(SERVICE_WORKER_PATH);
            console.log('[Push] Service Worker registrován');

            // 4. Vyžádání oprávnění
            console.log('[Push] Žádám o povolení…');
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                throw new Error('Permission denied');
            }
            console.log('[Push] Povolení uděleno');

            // 5. Vytvoření push odběru
            console.log('[Push] Přihlašuji odběr…');
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(PUBLIC_KEY)
            });

            // 6. Odeslání odběru na server
            await sendSubscriptionToServer(subscription, token, username);
            console.log('[Push] Odběr dokončen');

        } catch (error) {
            console.error('[Push] Inicializace selhala:', error);
            handlePushError(error);
        }
    }

    async function sendSubscriptionToServer(subscription, token, username) {
        const payload = {
            endpoint: subscription.endpoint,
            keys: {
                p256dh: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('p256dh')))),
                auth: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('auth'))))
            },
            username
        };

        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }
    }

    function handlePushError(error) {
        if (error.message.includes('Permission denied')) {
            alert('Pro příjem upozornění je potřeba je povolit v nastavení prohlížeče.');
        } else if (error.message.includes('Not authenticated')) {
            alert('Přihlaste se prosím do systému.');
        }
        console.error('[Push] Error:', error);
    }

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
    }

    navigator.serviceWorker.addEventListener('message', event => {
        if (event.data?.type === 'COPY_TEXT') {
            const text = event.data.text;
            navigator.clipboard.writeText(text)
                .then(() => {
                    console.log('Text zkopírován:', text);
                    alert('Zpráva byla zkopírována do schránky!');
                })
                .catch(err => {
                    console.error('Chyba při kopírování:', err);
                    alert('Zprávu se nepodařilo zkopírovat.');
                });
        }
    });

    // Inicializace při načtení
    window.addEventListener('load', () => {
        if ('serviceWorker' in navigator) {
            initPushNotifications().catch(console.error);
        }
    });
    let copyWindow = null;

    document.getElementById('enableCopyHelper').addEventListener('click', () => {
        if (!copyWindow || copyWindow.closed) {
            copyWindow = window.open(
                '/copy.html',
                'copyWindow',
                'width=1,height=1,left=9999,top=9999'
            );

            console.log('[Popup] copy.html otevřen na pozadí');
        } else {
            console.log('[Popup] copy.html je již otevřený');
        }
    });

</script>
