<button id="enableCopyHelper">Включить автокопирование</button>
<script>
    // Конфигурация
    const PUBLIC_KEY = 'BBoYaoc8zDDFcRjeUDuO4HI15lrxOhtqEgdWfcfkn5vqTHmUeZc_DU6yodFwDNcthvOyKSK-K_Us9xdEDVYR_5I';
    const SERVICE_WORKER_PATH = '/sw.js';
    const API_ENDPOINT = 'http://localhost:8082/api/push/subscribe';

    async function initPushNotifications() {
        try {
            // 1. Проверка поддержки
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                throw new Error('Push notifications not supported');
            }

            // 2. Проверка авторизации
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            if (!token || !username) {
                throw new Error('Not authenticated');
            }

            // 3. Регистрация Service Worker
            console.log('[Push] Registering Service Worker...');
            const registration = await navigator.serviceWorker.register(SERVICE_WORKER_PATH);
            console.log('[Push] Service Worker registered');

            // 4. Запрос разрешения
            console.log('[Push] Requesting permission...');
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                throw new Error('Permission denied');
            }
            console.log('[Push] Permission granted');

            // 5. Подписка на push-уведомления
            console.log('[Push] Subscribing...');
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(PUBLIC_KEY)
            });

            // 6. Отправка подписки на сервер
            await sendSubscriptionToServer(subscription, token, username);
            console.log('[Push] Subscription completed');

        } catch (error) {
            console.error('[Push] Initialization failed:', error);
            handlePushError(error);
        }
    }

    async function sendSubscriptionToServer(subscription, token, username) {
        const payload = {
            endpoint: subscription.endpoint,
            keys: {
                p256dh: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('p256dh')))),
                auth: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('auth'))))
            },
            username
        };

        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }
    }

    function handlePushError(error) {
        if (error.message.includes('Permission denied')) {
            alert('Для получения уведомлений разрешите их в настройках браузера');
        } else if (error.message.includes('Not authenticated')) {
            alert('Пожалуйста, войдите в систему');
        }
        console.error('[Push] Error:', error);
    }

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
    }

    navigator.serviceWorker.addEventListener('message', event => {
        if (event.data?.type === 'COPY_TEXT') {
            const text = event.data.text;
            navigator.clipboard.writeText(text)
                .then(() => {
                    console.log('Текст скопирован:', text);
                    alert('Сообщение скопировано в буфер обмена!');
                })
                .catch(err => {
                    console.error('Ошибка при копировании:', err);
                    alert('Не удалось скопировать сообщение');
                });
        }
    });

    // Инициализация при загрузке
    window.addEventListener('load', () => {
        if ('serviceWorker' in navigator) {
            initPushNotifications().catch(console.error);
        }
    });
    let copyWindow = null;

    document.getElementById('enableCopyHelper').addEventListener('click', () => {
        if (!copyWindow || copyWindow.closed) {
            copyWindow = window.open(
                '/copy.html',
                'copyWindow',
                'width=1,height=1,left=9999,top=9999'
            );

            console.log('[Popup] copy.html открыт в фоне');
        } else {
            console.log('[Popup] copy.html уже открыт');
        }
    });

</script>