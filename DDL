CREATE TABLE ADRESA 
    ( 
     ID_Adresa       INTEGER  NOT NULL , 
     ulice           VARCHAR2 (55)  NOT NULL , 
     cisloPopisne    VARCHAR2 (33)  NOT NULL , 
     Mesto_PSC       CHAR (5)  NOT NULL , 
     cisloOrientacni VARCHAR2 (33)  NOT NULL 
    ) 
;

ALTER TABLE ADRESA 
    ADD CONSTRAINT ADRESA_PK PRIMARY KEY ( ID_Adresa ) ;

CREATE TABLE APP_ROLE 
    ( 
     ID_Role INTEGER  NOT NULL , 
     nazev   VARCHAR2 (20)  NOT NULL 
    ) 
;

ALTER TABLE APP_ROLE 
    ADD CONSTRAINT APP_ROLE_PK PRIMARY KEY ( ID_Role ) ;

ALTER TABLE APP_ROLE 
    ADD CONSTRAINT APP_ROLE_nazev_UN UNIQUE ( nazev ) ;

CREATE TABLE APP_ROLE_PRAVO 
    ( 
     ID_Pravo INTEGER  NOT NULL , 
     ID_Role  INTEGER  NOT NULL 
    ) 
;

ALTER TABLE APP_ROLE_PRAVO 
    ADD CONSTRAINT APP_ROLE_PRAVO_PK PRIMARY KEY ( ID_Pravo, ID_Role ) ;

CREATE TABLE ARCHIV 
    ( 
     ID_Archiv INTEGER  NOT NULL , 
     nazev     VARCHAR2 (33)  NOT NULL , 
     popis     CLOB 
    ) 
;

ALTER TABLE ARCHIV 
    ADD CONSTRAINT ARCHIV_PK PRIMARY KEY ( ID_Archiv ) ;

ALTER TABLE ARCHIV ADD (PARENT_ID INTEGER);
ALTER TABLE ARCHIV
  ADD CONSTRAINT ARCHIV_PARENT_FK FOREIGN KEY (PARENT_ID) REFERENCES ARCHIV(ID_Archiv);
CREATE INDEX ARCHIV_PARENT_IDX ON ARCHIV(PARENT_ID);

CREATE TABLE DODAVATEL 
    ( 
     ID_uzivatelu INTEGER  NOT NULL , 
     firma        VARCHAR2 (100)  NOT NULL 
    ) 
;

ALTER TABLE DODAVATEL 
    ADD CONSTRAINT DODAVATEL_PK PRIMARY KEY ( ID_uzivatelu ) ;

ALTER TABLE DODAVATEL 
    ADD CONSTRAINT DODAVATEL_firma_UN UNIQUE ( firma ) ;

CREATE TABLE HOTOVOST 
    ( 
     ID_platba INTEGER  NOT NULL , 
     prijato   NUMBER (10,2)  NOT NULL , 
     vraceno   NUMBER (10,2)  NOT NULL 
    ) 
;

ALTER TABLE HOTOVOST 
    ADD CONSTRAINT HOTOVOST_PK PRIMARY KEY ( ID_platba ) ;

CREATE TABLE KARTA 
    ( 
     ID_platba  INTEGER  NOT NULL , 
     cisloKarty VARCHAR2 (19)  NOT NULL 
    ) 
;

ALTER TABLE KARTA 
    ADD CONSTRAINT KARTA_PK PRIMARY KEY ( ID_platba ) ;

CREATE TABLE Kategorie_zbozi 
    ( 
     ID_Kategorie INTEGER  NOT NULL , 
     nazev        VARCHAR2 (44)  NOT NULL , 
     popis        VARCHAR2 (111) 
    ) 
;

ALTER TABLE Kategorie_zbozi 
    ADD CONSTRAINT Kategorie_zbozi_PK PRIMARY KEY ( ID_Kategorie ) ;

ALTER TABLE Kategorie_zbozi 
    ADD CONSTRAINT Kategorie_zbozi_nazev_UN UNIQUE ( nazev ) ;

CREATE TABLE LOG 
    ( 
     ID_Log       INTEGER  NOT NULL , 
     tabulkaNazev VARCHAR2 (40)  NOT NULL , 
     operace      CHAR (1)  NOT NULL , 
     datumZmeny   DATE  NOT NULL , 
     idRekord     VARCHAR2 (100)  NOT NULL , 
     novaData     CLOB , 
     staraData    CLOB , 
     popis        CLOB , 
     ID_Archiv    INTEGER  NOT NULL 
    ) 
;

ALTER TABLE LOG 
    ADD CONSTRAINT CK_LOG_OPERACE 
    CHECK (operace IN ('I','U','D')) 
;

ALTER TABLE LOG 
    ADD CONSTRAINT LOG_PK PRIMARY KEY ( ID_Log ) ;

CREATE TABLE Mesto 
    ( 
     PSC   CHAR (5)  NOT NULL , 
     nazev VARCHAR2 (45)  NOT NULL , 
     kraj  VARCHAR2 (55)  NOT NULL 
    ) 
;

ALTER TABLE Mesto 
    ADD CONSTRAINT Mesto_PK PRIMARY KEY ( PSC ) ;

CREATE TABLE Notifikace 
    ( 
     ID_Notifikace INTEGER  NOT NULL , 
     authToken     VARCHAR2 (555)  NOT NULL , 
     endPoint      VARCHAR2 (444)  NOT NULL , 
     p256dh        VARCHAR2 (512)  NOT NULL , 
     adresat       VARCHAR2 (255)  NOT NULL , 
     ID_Zprava     INTEGER  NOT NULL 
    ) 
;
CREATE UNIQUE INDEX Ohlaseny__IDX ON Notifikace 
    ( 
     ID_Zprava ASC 
    ) 
;

ALTER TABLE Notifikace 
    ADD CONSTRAINT Notifikace_PK PRIMARY KEY ( ID_Notifikace, ID_Zprava ) ;

CREATE TABLE OBJEDNAVKA 
    ( 
     ID_Objednavka  INTEGER  NOT NULL , 
     datum          DATE  NOT NULL , 
     ID_Status      INTEGER  NOT NULL , 
     typ_objednavka VARCHAR2 (50)  NOT NULL , 
     poznamka       CLOB , 
     ID_Uzivatel    INTEGER  NOT NULL , 
     ID_Supermarket INTEGER  NOT NULL 
    ) 
;

ALTER TABLE OBJEDNAVKA 
    ADD CONSTRAINT OBJEDNAVKA_PK PRIMARY KEY ( ID_Objednavka ) ;

CREATE TABLE OBJEDNAVKA_ZBOZI 
    ( 
     pocet         INTEGER  NOT NULL , 
     ID_Objednavka INTEGER  NOT NULL , 
     ID_Zbozi      INTEGER  NOT NULL 
    ) 
;

ALTER TABLE OBJEDNAVKA_ZBOZI 
    ADD CONSTRAINT OBJEDNAVKA_ZBOZI_PK PRIMARY KEY ( ID_Objednavka, ID_Zbozi ) ;

CREATE TABLE PLATBA 
    ( 
     ID_platba     INTEGER  NOT NULL , 
     castka        NUMBER (10,2)  NOT NULL , 
     datum         DATE  NOT NULL , 
     ID_Objednavka INTEGER  NOT NULL , 
     platbaTyp     CHAR (2)  NOT NULL 
    ) 
;

ALTER TABLE PLATBA 
    ADD CONSTRAINT CK_PLATBA_TYP 
    CHECK (platbaTyp IN ('H','K')) 
;
CREATE UNIQUE INDEX PLATBA__IDX ON PLATBA 
    ( 
     ID_Objednavka ASC 
    ) 
;

ALTER TABLE PLATBA 
    ADD CONSTRAINT PLATBA_PK PRIMARY KEY ( ID_platba ) ;

CREATE TABLE PRAVO 
    ( 
     ID_Pravo INTEGER  NOT NULL , 
     nazev    VARCHAR2 (20)  NOT NULL , 
     kod      VARCHAR2 (255)  NOT NULL , 
     pristup  CHAR (1)  NOT NULL , 
     popis    CLOB 
    ) 
;

ALTER TABLE PRAVO 
    ADD CONSTRAINT pravo_pristup_chk
        CHECK (pristup IN (0,1));

ALTER TABLE PRAVO 
    ADD CONSTRAINT PRAVO_PK PRIMARY KEY ( ID_Pravo ) ;

ALTER TABLE PRAVO 
    ADD CONSTRAINT PRAVO_kod_UN UNIQUE ( kod ) ;

CREATE TABLE SKLAD 
    ( 
     ID_Sklad       INTEGER  NOT NULL , 
     nazev          VARCHAR2 (33)  NOT NULL , 
     kapacita       INTEGER  NOT NULL , 
     telefonniCislo VARCHAR2 (20)  NOT NULL , 
     ID_Supermarket INTEGER  NOT NULL 
    ) 
;

ALTER TABLE SKLAD 
    ADD CONSTRAINT SKLAD_PK PRIMARY KEY ( ID_Sklad ) ;

ALTER TABLE SKLAD 
    ADD CONSTRAINT SKLAD_nazev_UN UNIQUE ( nazev ) ;

CREATE TABLE SOUBOR 
    ( 
     ID_Soubor       INTEGER  NOT NULL , 
     nazev           VARCHAR2 (55)  NOT NULL , 
     typ             VARCHAR2 (55)  NOT NULL , 
     pripona         VARCHAR2 (15)  NOT NULL , 
     obsah           BLOB  NOT NULL , 
     datumNahrani    DATE  NOT NULL , 
     datumModifikace DATE  NOT NULL , 
     popis           CLOB , 
     ID_uzivatelu    INTEGER  NOT NULL , 
     ID_Archiv       INTEGER  NOT NULL 
    ) 
;

ALTER TABLE SOUBOR 
    ADD CONSTRAINT SOUBOR_PK PRIMARY KEY ( ID_Soubor ) ;

CREATE TABLE STATUS 
    ( 
     ID_Status INTEGER  NOT NULL , 
     nazev     VARCHAR2 (66)  NOT NULL 
    ) 
;

ALTER TABLE STATUS 
    ADD CONSTRAINT STATUS_PK PRIMARY KEY ( ID_Status ) ;

CREATE TABLE SUPERMARKET 
    ( 
     ID_Supermarket INTEGER  NOT NULL , 
     nazev          VARCHAR2 (100)  NOT NULL , 
     telefon        VARCHAR2 (20)  NOT NULL , 
     email          VARCHAR2 (255)  NOT NULL , 
     ID_Adresa      INTEGER  NOT NULL 
    ) 
;
CREATE UNIQUE INDEX SUPERMARKET__IDX ON SUPERMARKET 
    ( 
     ID_Adresa ASC 
    ) 
;

ALTER TABLE SUPERMARKET 
    ADD CONSTRAINT SUPERMARKET_PK PRIMARY KEY ( ID_Supermarket ) ;

ALTER TABLE SUPERMARKET 
    ADD CONSTRAINT SUPERMARKET_nazev_UN UNIQUE ( nazev ) ;

CREATE TABLE UZIVATEL 
    ( 
     ID_Uzivatel    INTEGER  NOT NULL , 
     jmeno          VARCHAR2 (15)  NOT NULL , 
     prijmeni       VARCHAR2 (15)  NOT NULL , 
     email          VARCHAR2 (255)  NOT NULL , 
     heslo          VARCHAR2 (255)  NOT NULL , 
     telefonniCislo VARCHAR2 (20)  NOT NULL , 
     ID_Adresa      INTEGER , 
     ID_Role        INTEGER 
    ) 
;

ALTER TABLE UZIVATEL 
    ADD CONSTRAINT UZIVATEL_PK PRIMARY KEY ( ID_Uzivatel ) ;

ALTER TABLE UZIVATEL 
    ADD CONSTRAINT UZIVATEL_telefonniCislo_UN UNIQUE ( telefonniCislo ) ;

ALTER TABLE UZIVATEL 
    ADD CONSTRAINT UZIVATEL_email_UN UNIQUE ( email ) ;

CREATE TABLE ZAKAZNIK 
    ( 
     ID_uzivatelu  INTEGER  NOT NULL , 
     kartaVernosti VARCHAR2 (20) 
    ) 
;

ALTER TABLE ZAKAZNIK 
    ADD CONSTRAINT ZAKAZNIK_PK PRIMARY KEY ( ID_uzivatelu ) ;

ALTER TABLE ZAKAZNIK 
    ADD CONSTRAINT ZAKAZNIK_kartaVernosti_UN UNIQUE ( kartaVernosti ) ;

CREATE TABLE ZAMESTNANEC 
    ( 
     ID_uzivatelu INTEGER  NOT NULL , 
     mzda         NUMBER (10,2)  NOT NULL , 
     datumNastupa DATE  NOT NULL , 
     pozice       VARCHAR2 (50)  NOT NULL 
    ) 
;

ALTER TABLE ZAMESTNANEC 
    ADD CONSTRAINT ZAMESTNANEC_PK PRIMARY KEY ( ID_uzivatelu ) ;

CREATE TABLE ZBOZI 
    ( 
     ID_Zbozi       INTEGER  NOT NULL , 
     nazev          VARCHAR2 (55)  NOT NULL , 
     cena           NUMBER (10,2)  NOT NULL , 
     mnozstvi       INTEGER  NOT NULL , 
     minMnozstvi    INTEGER  NOT NULL , 
     popis          CLOB , 
     SKLAD_ID_Sklad INTEGER  NOT NULL , 
     ID_Kategorie   INTEGER  NOT NULL 
    ) 
;

ALTER TABLE ZBOZI 
    ADD CONSTRAINT ZBOZI_PK PRIMARY KEY ( ID_Zbozi ) ;

ALTER TABLE ZBOZI
ADD CONSTRAINT uq_zbozi_sklad UNIQUE (nazev, SKLAD_ID_Sklad);

CREATE TABLE ZBOZI_DODAVATEL 
    ( 
     ID_uzivatelu INTEGER  NOT NULL , 
     ID_Zbozi     INTEGER  NOT NULL 
    ) 
;

ALTER TABLE ZBOZI_DODAVATEL 
    ADD CONSTRAINT ZBOZI_DODAVATEL_PK PRIMARY KEY ( ID_uzivatelu, ID_Zbozi ) ;

CREATE TABLE ZPRAVA 
    ( 
     ID_Zprava     INTEGER  NOT NULL , 
     zprava        CLOB  NOT NULL , 
     datumZasilani DATE  NOT NULL , 
     prijimac_ID   INTEGER  NOT NULL , 
     odesilatel_ID INTEGER  NOT NULL 
    ) 
;

ALTER TABLE ZPRAVA 
    ADD CONSTRAINT ZPRAVA_PK PRIMARY KEY ( ID_Zprava ) ;

ALTER TABLE ADRESA 
    ADD CONSTRAINT ADRESA_Mesto_FK FOREIGN KEY 
    ( 
     Mesto_PSC
    ) 
    REFERENCES Mesto 
    ( 
     PSC
    ) 
;

ALTER TABLE APP_ROLE_PRAVO 
    ADD CONSTRAINT APP_ROLE_PRAVO_FK FOREIGN KEY 
    ( 
     ID_Pravo
    ) 
    REFERENCES PRAVO 
    ( 
     ID_Pravo
    ) 
;

ALTER TABLE DODAVATEL 
    ADD CONSTRAINT DODAVATEL_UZIVATEL_FK FOREIGN KEY 
    ( 
     ID_uzivatelu
    ) 
    REFERENCES UZIVATEL 
    ( 
     ID_Uzivatel
    ) 
;

ALTER TABLE HOTOVOST 
    ADD CONSTRAINT HOTOVOST_PLATBA_FK FOREIGN KEY 
    ( 
     ID_platba
    ) 
    REFERENCES PLATBA 
    ( 
     ID_platba
    ) 
;

ALTER TABLE KARTA 
    ADD CONSTRAINT KARTA_PLATBA_FK FOREIGN KEY 
    ( 
     ID_platba
    ) 
    REFERENCES PLATBA 
    ( 
     ID_platba
    ) 
;

ALTER TABLE LOG 
    ADD CONSTRAINT LOG_ARCHIV_FK FOREIGN KEY 
    ( 
     ID_Archiv
    ) 
    REFERENCES ARCHIV 
    ( 
     ID_Archiv
    ) 
;

ALTER TABLE Notifikace 
    ADD CONSTRAINT Notifikace_ZPRAVA_FK FOREIGN KEY 
    ( 
     ID_Zprava
    ) 
    REFERENCES ZPRAVA 
    ( 
     ID_Zprava
    ) 
;

ALTER TABLE OBJEDNAVKA 
    ADD CONSTRAINT OBJEDNAVKA_STATUS_FK FOREIGN KEY 
    ( 
     ID_Status
    ) 
    REFERENCES STATUS 
    ( 
     ID_Status
    ) 
;

ALTER TABLE OBJEDNAVKA 
    ADD CONSTRAINT OBJEDNAVKA_SUPERMARKET_FK FOREIGN KEY 
    ( 
     ID_Supermarket
    ) 
    REFERENCES SUPERMARKET 
    ( 
     ID_Supermarket
    ) 
;

ALTER TABLE OBJEDNAVKA 
    ADD CONSTRAINT OBJEDNAVKA_UZIVATEL_FK FOREIGN KEY 
    ( 
     ID_Uzivatel
    ) 
    REFERENCES UZIVATEL 
    ( 
     ID_Uzivatel
    ) 
;

ALTER TABLE OBJEDNAVKA_ZBOZI 
    ADD CONSTRAINT OBJEDNAVKA_ZBOZI_OBJEDNAVKA_FK FOREIGN KEY 
    ( 
     ID_Objednavka
    ) 
    REFERENCES OBJEDNAVKA 
    ( 
     ID_Objednavka
    ) 
;

ALTER TABLE OBJEDNAVKA_ZBOZI 
    ADD CONSTRAINT OBJEDNAVKA_ZBOZI_ZBOZI_FK FOREIGN KEY 
    ( 
     ID_Zbozi
    ) 
    REFERENCES ZBOZI 
    ( 
     ID_Zbozi
    ) 
;

ALTER TABLE PLATBA 
    ADD CONSTRAINT PLATBA_OBJEDNAVKA_FK FOREIGN KEY 
    ( 
     ID_Objednavka
    ) 
    REFERENCES OBJEDNAVKA 
    ( 
     ID_Objednavka
    ) 
;

ALTER TABLE APP_ROLE_PRAVO 
    ADD CONSTRAINT PRAVO_APP_ROLE_FK FOREIGN KEY 
    ( 
     ID_Role
    ) 
    REFERENCES APP_ROLE 
    ( 
     ID_Role
    ) 
;

ALTER TABLE SKLAD 
    ADD CONSTRAINT SKLAD_SUPERMARKET_FK FOREIGN KEY 
    ( 
     ID_Supermarket
    ) 
    REFERENCES SUPERMARKET 
    ( 
     ID_Supermarket
    ) 
;

ALTER TABLE SOUBOR 
    ADD CONSTRAINT SOUBOR_ARCHIV_FK FOREIGN KEY 
    ( 
     ID_Archiv
    ) 
    REFERENCES ARCHIV 
    ( 
     ID_Archiv
    ) 
;

ALTER TABLE SOUBOR
  ADD CONSTRAINT SOUBOR_UZIVATEL_FK
  FOREIGN KEY (ID_UZIVATELU) REFERENCES UZIVATEL(ID_UZIVATEL);

ALTER TABLE SUPERMARKET 
    ADD CONSTRAINT SUPERMARKET_ADRESA_FK FOREIGN KEY 
    ( 
     ID_Adresa
    ) 
    REFERENCES ADRESA 
    ( 
     ID_Adresa
    ) 
;

ALTER TABLE UZIVATEL 
    ADD CONSTRAINT UZIVATEL_ADRESA_FK FOREIGN KEY 
    ( 
     ID_Adresa
    ) 
    REFERENCES ADRESA 
    ( 
     ID_Adresa
    ) 
;

ALTER TABLE UZIVATEL 
    ADD CONSTRAINT UZIVATEL_APP_ROLE_FK FOREIGN KEY 
    ( 
     ID_Role
    ) 
    REFERENCES APP_ROLE 
    ( 
     ID_Role
    ) 
;

ALTER TABLE ZAKAZNIK 
    ADD CONSTRAINT ZAKAZNIK_UZIVATEL_FK FOREIGN KEY 
    ( 
     ID_uzivatelu
    ) 
    REFERENCES UZIVATEL 
    ( 
     ID_Uzivatel
    ) 
;

ALTER TABLE ZAMESTNANEC 
    ADD CONSTRAINT ZAMESTNANEC_UZIVATEL_FK FOREIGN KEY 
    ( 
     ID_uzivatelu
    ) 
    REFERENCES UZIVATEL 
    ( 
     ID_Uzivatel
    ) 
;

ALTER TABLE ZBOZI_DODAVATEL 
    ADD CONSTRAINT ZBOZI_DODAVATEL_DODAVATEL_FK FOREIGN KEY 
    ( 
     ID_uzivatelu
    ) 
    REFERENCES DODAVATEL 
    ( 
     ID_uzivatelu
    ) 
;

ALTER TABLE ZBOZI_DODAVATEL 
    ADD CONSTRAINT ZBOZI_DODAVATEL_ZBOZI_FK FOREIGN KEY 
    ( 
     ID_Zbozi
    ) 
    REFERENCES ZBOZI 
    ( 
     ID_Zbozi
    ) 
;

ALTER TABLE ZBOZI 
    ADD CONSTRAINT ZBOZI_Kategorie_zbozi_FK FOREIGN KEY 
    ( 
     ID_Kategorie
    ) 
    REFERENCES Kategorie_zbozi 
    ( 
     ID_Kategorie
    ) 
;

ALTER TABLE ZBOZI 
    ADD CONSTRAINT ZBOZI_SKLAD_FK FOREIGN KEY 
    ( 
     SKLAD_ID_Sklad
    ) 
    REFERENCES SKLAD 
    ( 
     ID_Sklad
    ) 
;

ALTER TABLE ZPRAVA 
    ADD CONSTRAINT ZPRAVA_UZIVATEL_FK FOREIGN KEY 
    ( 
     prijimac_ID
    ) 
    REFERENCES UZIVATEL 
    ( 
     ID_Uzivatel
    ) 
;

ALTER TABLE ZPRAVA 
    ADD CONSTRAINT ZPRAVA_UZIVATEL_FKv2 FOREIGN KEY 
    ( 
     odesilatel_ID
    ) 
    REFERENCES UZIVATEL 
    ( 
     ID_Uzivatel
    ) 
;

CREATE OR REPLACE TRIGGER ARC_FKArc_1_HOTOVOST 
BEFORE INSERT OR UPDATE OF ID_platba 
ON HOTOVOST 
FOR EACH ROW 
DECLARE 
    d CHAR (2); 
BEGIN 
    SELECT A.platbaTyp INTO d 
    FROM PLATBA A 
    WHERE A.ID_platba = :new.ID_platba; 
    IF (d IS NULL OR d <> 'H') THEN 
        raise_application_error(-20223,'FK HOTOVOST_PLATBA_FK in Table HOTOVOST violates Arc constraint on Table PLATBA - discriminator column platbaTyp doesn''t have value ''H'''); 
    END IF; 
    EXCEPTION 
    WHEN NO_DATA_FOUND THEN 
        NULL; 
    WHEN OTHERS THEN 
        RAISE; 
END; 
/

CREATE OR REPLACE TRIGGER ARC_FKArc_1_KARTA 
BEFORE INSERT OR UPDATE OF ID_platba 
ON KARTA 
FOR EACH ROW 
DECLARE 
    d CHAR (2); 
BEGIN 
    SELECT A.platbaTyp INTO d 
    FROM PLATBA A 
    WHERE A.ID_platba = :new.ID_platba; 
    IF (d IS NULL OR d <> 'K') THEN 
        raise_application_error(-20223,'FK KARTA_PLATBA_FK in Table KARTA violates Arc constraint on Table PLATBA - discriminator column platbaTyp doesn''t have value ''K'''); 
    END IF; 
    EXCEPTION 
    WHEN NO_DATA_FOUND THEN 
        NULL; 
    WHEN OTHERS THEN 
        RAISE; 
END; 
/

CREATE OR REPLACE TRIGGER ARC_FKArc_3_ZAKAZNIK 
BEFORE INSERT OR UPDATE OF ID_uzivatelu 
ON ZAKAZNIK 
FOR EACH ROW 
DECLARE 
    d INTEGER; 
BEGIN 
    SELECT A.ID_Role INTO d 
    FROM UZIVATEL A 
    WHERE A.ID_Uzivatel = :new.ID_uzivatelu; 
    IF (d IS NULL OR d <> 3) THEN 
        raise_application_error(-20223,'FK ZAKAZNIK_UZIVATEL_FK in Table ZAKAZNIK violates Arc constraint on Table UZIVATEL - discriminator column ID_Role doesn''t have value 3'); 
    END IF; 
    EXCEPTION 
    WHEN NO_DATA_FOUND THEN 
        NULL; 
    WHEN OTHERS THEN 
        RAISE; 
END; 
/

CREATE OR REPLACE TRIGGER ARC_FKArc_3_ZAMESTNANEC 
BEFORE INSERT OR UPDATE OF ID_uzivatelu 
ON ZAMESTNANEC 
FOR EACH ROW 
DECLARE 
    d INTEGER; 
BEGIN 
    SELECT A.ID_Role INTO d 
    FROM UZIVATEL A 
    WHERE A.ID_Uzivatel = :new.ID_uzivatelu; 
    IF (d IS NULL OR d <> 4) THEN 
        raise_application_error(-20223,'FK ZAMESTNANEC_UZIVATEL_FK in Table ZAMESTNANEC violates Arc constraint on Table UZIVATEL - discriminator column ID_Role doesn''t have value 4'); 
    END IF; 
    EXCEPTION 
    WHEN NO_DATA_FOUND THEN 
        NULL; 
    WHEN OTHERS THEN 
        RAISE; 
END; 
/

CREATE OR REPLACE TRIGGER ARC_FKArc_3_DODAVATEL 
BEFORE INSERT OR UPDATE OF ID_uzivatelu 
ON DODAVATEL 
FOR EACH ROW 
DECLARE 
    d INTEGER; 
BEGIN 
    SELECT A.ID_Role INTO d 
    FROM UZIVATEL A 
    WHERE A.ID_Uzivatel = :new.ID_uzivatelu; 
    IF (d IS NULL OR d <> 2) THEN 
        raise_application_error(-20223,'FK DODAVATEL_UZIVATEL_FK in Table DODAVATEL violates Arc constraint on Table UZIVATEL - discriminator column ID_Role doesn''t have value 2'); 
    END IF; 
    EXCEPTION 
    WHEN NO_DATA_FOUND THEN 
        NULL; 
    WHEN OTHERS THEN 
        RAISE; 
END; 
/

CREATE SEQUENCE SEQ_ADRESA_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_ADRESA_ID 
BEFORE INSERT ON ADRESA 
FOR EACH ROW 
WHEN (NEW.ID_Adresa IS NULL) 
BEGIN 
    :NEW.ID_Adresa := SEQ_ADRESA_ID.NEXTVAL; 
END;
/

CREATE SEQUENCE SEQ_ROLE_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_ROLE_ID 
BEFORE INSERT ON APP_ROLE 
FOR EACH ROW 
WHEN (NEW.ID_Role IS NULL) 
BEGIN 
    :NEW.ID_Role := SEQ_ROLE_ID.NEXTVAL; 
END;
/

CREATE SEQUENCE SEQ_ARCHIV_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_ARCHIV_ID 
BEFORE INSERT ON ARCHIV 
FOR EACH ROW 
WHEN (NEW.ID_Archiv IS NULL) 
BEGIN 
    :NEW.ID_Archiv := SEQ_ARCHIV_ID.NEXTVAL; 
END;
/

CREATE SEQUENCE SEQ_KATEGORIE_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_KATEGORIE_ID 
BEFORE INSERT ON Kategorie_zbozi 
FOR EACH ROW 
WHEN (NEW.ID_Kategorie IS NULL) 
BEGIN 
    :NEW.ID_Kategorie := SEQ_KATEGORIE_ID.NEXTVAL; 
END;
/

CREATE SEQUENCE SEQ_LOG_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_LOG_ID 
BEFORE INSERT ON LOG 
FOR EACH ROW 
WHEN (NEW.ID_Log IS NULL) 
BEGIN 
    :NEW.ID_Log := SEQ_LOG_ID.NEXTVAL; 
END;
/

CREATE SEQUENCE SEQ_NOTIFIKACE_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_NOTIFIKACE_ID 
BEFORE INSERT ON Notifikace 
FOR EACH ROW 
WHEN (NEW.ID_Notifikace IS NULL) 
BEGIN 
    :NEW.ID_Notifikace := SEQ_NOTIFIKACE_ID.NEXTVAL; 
END;
/

CREATE SEQUENCE SEQ_OBJEDNAVKA_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_OBJEDNAVKA_ID 
BEFORE INSERT ON OBJEDNAVKA 
FOR EACH ROW 
WHEN (NEW.ID_Objednavka IS NULL) 
BEGIN 
    :NEW.ID_Objednavka := SEQ_OBJEDNAVKA_ID.NEXTVAL; 
END;
/

CREATE SEQUENCE SEQ_PLATBA_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_PLATBA_ID 
BEFORE INSERT ON PLATBA 
FOR EACH ROW 
WHEN (NEW.ID_platba IS NULL) 
BEGIN 
    :NEW.ID_platba := SEQ_PLATBA_ID.NEXTVAL; 
END;
/

CREATE SEQUENCE SEQ_PRAVO_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_PRAVO_ID 
BEFORE INSERT ON PRAVO 
FOR EACH ROW 
WHEN (NEW.ID_Pravo IS NULL) 
BEGIN 
    :NEW.ID_Pravo := SEQ_PRAVO_ID.NEXTVAL; 
END;
/

CREATE SEQUENCE SEQ_SKALD_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_SKALD_ID 
BEFORE INSERT ON SKLAD 
FOR EACH ROW 
WHEN (NEW.ID_Sklad IS NULL) 
BEGIN 
    :NEW.ID_Sklad := SEQ_SKALD_ID.NEXTVAL; 
END;
/

CREATE SEQUENCE SEQ_SOUBOR_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_SOUBOR_ID 
BEFORE INSERT ON SOUBOR 
FOR EACH ROW 
WHEN (NEW.ID_Soubor IS NULL) 
BEGIN 
    :NEW.ID_Soubor := SEQ_SOUBOR_ID.NEXTVAL; 
END;
/

CREATE SEQUENCE SEQ_STATUS_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_STATUS_ID 
BEFORE INSERT ON STATUS 
FOR EACH ROW 
WHEN (NEW.ID_Status IS NULL) 
BEGIN 
    :NEW.ID_Status := SEQ_STATUS_ID.NEXTVAL; 
END;
/

CREATE SEQUENCE SEQ_SUPERMARKET_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_SUPERMARKET_ID 
BEFORE INSERT ON SUPERMARKET 
FOR EACH ROW 
WHEN (NEW.ID_Supermarket IS NULL) 
BEGIN 
    :NEW.ID_Supermarket := SEQ_SUPERMARKET_ID.NEXTVAL; 
END;
/

CREATE SEQUENCE SEQ_UZIVATEL_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_UZIVATEL_ID 
BEFORE INSERT ON UZIVATEL 
FOR EACH ROW 
WHEN (NEW.ID_Uzivatel IS NULL) 
BEGIN 
    :NEW.ID_Uzivatel := SEQ_UZIVATEL_ID.NEXTVAL; 
END;
/

CREATE SEQUENCE SEQ_ZBOZI_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_ZBOZI_ID 
BEFORE INSERT ON ZBOZI 
FOR EACH ROW 
WHEN (NEW.ID_Zbozi IS NULL) 
BEGIN 
    :NEW.ID_Zbozi := SEQ_ZBOZI_ID.NEXTVAL; 
END;
/

CREATE SEQUENCE SEQ_ZPRAVA_ID 
START WITH 1 
    NOCACHE 
    ORDER ;

CREATE OR REPLACE TRIGGER TRG_ZPRAVA_ID 
BEFORE INSERT ON ZPRAVA 
FOR EACH ROW 
WHEN (NEW.ID_Zprava IS NULL) 
BEGIN 
    :NEW.ID_Zprava := SEQ_ZPRAVA_ID.NEXTVAL; 
END;
/

ALTER TABLE SOUBOR MODIFY TYP VARCHAR2(255);
ALTER TABLE SOUBOR MODIFY NAZEV VARCHAR2(255);

SELECT id_archiv, nazev, parent_id, LEVEL AS lvl,
       SYS_CONNECT_BY_PATH(nazev, '/') AS cesta
FROM archiv
START WITH parent_id IS NULL
CONNECT BY PRIOR id_archiv = parent_id
ORDER SIBLINGS BY nazev;


ALTER TABLE ZBOZI
ADD CONSTRAINT uq_zbozi_sklad UNIQUE (nazev, SKLAD_ID_Sklad);


--------------------------------------------------------------------------------
-- Balíček pro řízení ARC kontrol (umožní je přeskočit v řízené proceduře).
--------------------------------------------------------------------------------
CREATE OR REPLACE PACKAGE PKG_ARC_CTRL AS
  PROCEDURE set_skip_arc(p_value BOOLEAN);
  FUNCTION skip_arc RETURN BOOLEAN;
END PKG_ARC_CTRL;
/

CREATE OR REPLACE PACKAGE BODY PKG_ARC_CTRL AS
  g_skip_arc BOOLEAN := FALSE;

  PROCEDURE set_skip_arc(p_value BOOLEAN) IS
  BEGIN
    g_skip_arc := NVL(p_value, FALSE);
  END;

  FUNCTION skip_arc RETURN BOOLEAN IS
  BEGIN
    RETURN g_skip_arc;
  END;
END PKG_ARC_CTRL;
/


DROP TRIGGER ARC_FKArc_1_HOTOVOST;
DROP TRIGGER ARC_FKArc_1_KARTA;

--------------------------------------------------------------------------------
-- ARC pravidlo: PLATBA ▷ KARTA
-- Hlavní kontrola musí být na tabulce PLATBA, ne na KARTA
-- Tím se odstraní ORA-04091 a zachová se správné ARC chování.
--------------------------------------------------------------------------------
CREATE OR REPLACE TRIGGER ARC_PLATBA_KARTA_CHECK
AFTER INSERT OR UPDATE ON PLATBA
DECLARE
    CURSOR c IS
        SELECT ID_platba, platbaTyp
        FROM PLATBA
        WHERE platbaTyp = 'K';
    v_count NUMBER;
BEGIN
    IF PKG_ARC_CTRL.skip_arc THEN
        RETURN;
    END IF;

    -- ARC pravidlo: pokud platbaTyp = 'K', musí existovat přesně jeden řádek v KARTA
    FOR r IN c LOOP
        SELECT COUNT(*)
        INTO v_count
        FROM KARTA
        WHERE ID_platba = r.ID_platba;

        IF v_count = 0 THEN
            RAISE_APPLICATION_ERROR(
                -20223,
                'Chybí záznam v KARTA pro PLATBA=' || r.ID_platba
            );
        END IF;
    END LOOP;
END;
/


--------------------------------------------------------------------------------
-- ARC pravidlo: PLATBA ▷ HOTOVOST
-- Kontrola se provádí po INSERT/UPDATE na PLATBA.
-- Zajišťuje, že pokud platbaTyp = 'H', existuje odpovídající řádek v HOTOVOST.
--------------------------------------------------------------------------------
CREATE OR REPLACE TRIGGER ARC_PLATBA_HOTOVOST_CHECK
AFTER INSERT OR UPDATE ON PLATBA
DECLARE
    CURSOR c IS
        SELECT ID_platba, platbaTyp
        FROM PLATBA
        WHERE platbaTyp = 'H';
    v_count NUMBER;
BEGIN
    IF PKG_ARC_CTRL.skip_arc THEN
        RETURN;
    END IF;

    -- Pro každou platbu typu HOTOVOST zkontrolujeme, zda existuje odpovídající záznam
    FOR r IN c LOOP
        SELECT COUNT(*)
        INTO v_count
        FROM HOTOVOST
        WHERE ID_platba = r.ID_platba;

        IF v_count = 0 THEN
            RAISE_APPLICATION_ERROR(
                -20224,
                'Chybí záznam v HOTOVOST pro PLATBA=' || r.ID_platba ||
                ' (ARC pravidlo platbaTyp = H)'
            );
        END IF;
    END LOOP;
END;
/



ALTER TABLE SOUBOR DROP CONSTRAINT SOUBOR_ZAMESTNANEC_FK;
ALTER TABLE SOUBOR
  ADD CONSTRAINT SOUBOR_UZIVATEL_FK
  FOREIGN KEY (ID_UZIVATELU) REFERENCES UZIVATEL(ID_UZIVATEL);

------------------------------------------------------------
-- Sekvence
------------------------------------------------------------
CREATE SEQUENCE "SEQ_UCET_ID" MINVALUE 1 MAXVALUE 999999999999 INCREMENT BY 1 START WITH 1 NOCACHE NOCYCLE NOORDER;
CREATE SEQUENCE "SEQ_POHYB_UCTU_ID" MINVALUE 1 MAXVALUE 999999999999 INCREMENT BY 1 START WITH 1 NOCACHE NOCYCLE NOORDER;

------------------------------------------------------------
-- UCET (кошелек)
------------------------------------------------------------
CREATE TABLE "UCET" (
    "ID_UCET"         NUMBER(18,0),
    "ID_UZIVATEL"     NUMBER(18,0) NOT NULL,
    "ZUSTATEK"        NUMBER(12,2) DEFAULT 0 NOT NULL,
    "DATUM_VYTVORENI" DATE DEFAULT SYSDATE NOT NULL
);

ALTER TABLE "UCET" ADD CONSTRAINT "UCET_PK" PRIMARY KEY ("ID_UCET");
ALTER TABLE "UCET" ADD CONSTRAINT "UCET_UZIVATEL_FK" FOREIGN KEY ("ID_UZIVATEL") REFERENCES "UZIVATEL" ("ID_UZIVATEL");
ALTER TABLE "UCET" ADD CONSTRAINT "UCET_UZIVATEL_UQ" UNIQUE ("ID_UZIVATEL");

CREATE OR REPLACE TRIGGER "BI_UCET"
BEFORE INSERT ON "UCET"
FOR EACH ROW
WHEN (NEW."ID_UCET" IS NULL)
BEGIN
  SELECT "SEQ_UCET_ID".NEXTVAL INTO :NEW."ID_UCET" FROM dual;
END;
/

------------------------------------------------------------
-- POHYB_UCTU (движения кошелька)
------------------------------------------------------------
CREATE TABLE "POHYB_UCTU" (
    "ID_POHYB"        NUMBER(18,0),
    "ID_UCET"         NUMBER(18,0) NOT NULL,
    "SMER"            CHAR(1 BYTE) NOT NULL,              -- P=pripsání (credit), D=debet
    "METODA"          VARCHAR2(12 BYTE) NOT NULL,         -- KARTA/HOTOVOST/OBJEDNAVKA/REFUND
    "CASTKA"          NUMBER(12,2) NOT NULL,
    "POZNAMKA"        VARCHAR2(255 BYTE),
    "DATUM_VYTVORENI" DATE DEFAULT SYSDATE NOT NULL,
    "ID_OBJEDNAVKA"   NUMBER(18,0),
    "CISLOKARTY"      VARCHAR2(19 BYTE)
);

ALTER TABLE "POHYB_UCTU" ADD CONSTRAINT "POHYB_UCTU_PK" PRIMARY KEY ("ID_POHYB");
ALTER TABLE "POHYB_UCTU" ADD CONSTRAINT "PU_UCET_FK" FOREIGN KEY ("ID_UCET") REFERENCES "UCET" ("ID_UCET");
ALTER TABLE "POHYB_UCTU" ADD CONSTRAINT "PU_OBJ_FK" FOREIGN KEY ("ID_OBJEDNAVKA") REFERENCES "OBJEDNAVKA" ("ID_OBJEDNAVKA");
ALTER TABLE "POHYB_UCTU" ADD CONSTRAINT "CK_PU_SMER" CHECK ("SMER" IN ('P','D'));
ALTER TABLE "POHYB_UCTU" ADD CONSTRAINT "CK_PU_METODA" CHECK ("METODA" IN ('KARTA','HOTOVOST','OBJEDNAVKA','REFUND'));
ALTER TABLE "POHYB_UCTU" ADD CONSTRAINT "CK_PU_CASTKA_POS" CHECK ("CASTKA" > 0);

CREATE INDEX "PU_UCET_IDX" ON "POHYB_UCTU" ("ID_UCET");
CREATE INDEX "PU_OBJ_IDX"  ON "POHYB_UCTU" ("ID_OBJEDNAVKA");

CREATE OR REPLACE TRIGGER "BI_POHYB_UCTU"
BEFORE INSERT ON "POHYB_UCTU"
FOR EACH ROW
WHEN (NEW."ID_POHYB" IS NULL)
BEGIN
  SELECT "SEQ_POHYB_UCTU_ID".NEXTVAL INTO :NEW."ID_POHYB" FROM dual;
END;
/

------------------------------------------------------------
-- PLATBA: добавить тип U и ссылку на движение кошелька
------------------------------------------------------------
ALTER TABLE "PLATBA" ADD ("ID_POHYB_UCTU" NUMBER(18,0));

BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE "PLATBA" DROP CONSTRAINT "CK_PLATBA_TYP"';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -2443 THEN RAISE; END IF;
END;
/

ALTER TABLE "PLATBA" ADD CONSTRAINT "CK_PLATBA_TYP" CHECK ("PLATBATYP" IN ('H','K','U'));
ALTER TABLE "PLATBA" ADD CONSTRAINT "PLATBA_PU_FK" FOREIGN KEY ("ID_POHYB_UCTU") REFERENCES "POHYB_UCTU" ("ID_POHYB");
CREATE INDEX "PLATBA_PU_IDX" ON "PLATBA" ("ID_POHYB_UCTU");
